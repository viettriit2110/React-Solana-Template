{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nimport EventEmitter from 'eventemitter3';\nimport { PublicKey } from '@solana/web3.js';\nimport bs58 from 'bs58';\nexport default class Wallet extends EventEmitter {\n  constructor(provider, _network) {\n    super();\n    this._network = _network;\n    this._publicKey = null;\n    this._popup = null;\n    this._handlerAdded = false;\n    this._nextRequestId = 1;\n    this._autoApprove = false;\n    this._responsePromises = new Map();\n    this.handleMessage = e => {\n      var _a;\n      if (this._injectedProvider && e.source === window || e.origin === ((_a = this._providerUrl) === null || _a === void 0 ? void 0 : _a.origin) && e.source === this._popup) {\n        if (e.data.method === 'connected') {\n          const newPublicKey = new PublicKey(e.data.params.publicKey);\n          if (!this._publicKey || !this._publicKey.equals(newPublicKey)) {\n            if (this._publicKey && !this._publicKey.equals(newPublicKey)) {\n              this.handleDisconnect();\n            }\n            this._publicKey = newPublicKey;\n            this._autoApprove = !!e.data.params.autoApprove;\n            this.emit('connect', this._publicKey);\n          }\n        } else if (e.data.method === 'disconnected') {\n          this.handleDisconnect();\n        } else if (e.data.result || e.data.error) {\n          const promises = this._responsePromises.get(e.data.id);\n          if (promises) {\n            const [resolve, reject] = promises;\n            if (e.data.result) {\n              resolve(e.data.result);\n            } else {\n              reject(new Error(e.data.error));\n            }\n          }\n        }\n      }\n    };\n    this._beforeUnload = () => {\n      void this.disconnect();\n    };\n    if (isInjectedProvider(provider)) {\n      this._injectedProvider = provider;\n    } else if (isString(provider)) {\n      this._providerUrl = new URL(provider);\n      this._providerUrl.hash = new URLSearchParams({\n        origin: window.location.origin,\n        network: this._network\n      }).toString();\n    } else {\n      throw new Error('provider parameter must be an injected provider or a URL string.');\n    }\n  }\n  handleConnect() {\n    var _a;\n    if (!this._handlerAdded) {\n      this._handlerAdded = true;\n      window.addEventListener('message', this.handleMessage);\n      window.addEventListener('beforeunload', this._beforeUnload);\n    }\n    if (this._injectedProvider) {\n      return new Promise(resolve => {\n        void this.sendRequest('connect', {});\n        resolve();\n      });\n    } else {\n      window.name = 'parent';\n      this._popup = window.open((_a = this._providerUrl) === null || _a === void 0 ? void 0 : _a.toString(), '_blank', 'location,resizable,width=460,height=675');\n      return new Promise(resolve => {\n        this.once('connect', resolve);\n      });\n    }\n  }\n  handleDisconnect() {\n    if (this._handlerAdded) {\n      this._handlerAdded = false;\n      window.removeEventListener('message', this.handleMessage);\n      window.removeEventListener('beforeunload', this._beforeUnload);\n    }\n    if (this._publicKey) {\n      this._publicKey = null;\n      this.emit('disconnect');\n    }\n    this._responsePromises.forEach((_ref, id) => {\n      let [, reject] = _ref;\n      this._responsePromises.delete(id);\n      reject(new Error('Wallet disconnected'));\n    });\n  }\n  sendRequest(method, params) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (method !== 'connect' && !this.connected) {\n        throw new Error('Wallet not connected');\n      }\n      const requestId = this._nextRequestId;\n      ++this._nextRequestId;\n      return new Promise((resolve, reject) => {\n        var _a, _b, _c, _d;\n        this._responsePromises.set(requestId, [resolve, reject]);\n        if (this._injectedProvider) {\n          this._injectedProvider.postMessage({\n            jsonrpc: '2.0',\n            id: requestId,\n            method,\n            params: Object.assign({\n              network: this._network\n            }, params)\n          });\n        } else {\n          (_a = this._popup) === null || _a === void 0 ? void 0 : _a.postMessage({\n            jsonrpc: '2.0',\n            id: requestId,\n            method,\n            params\n          }, (_c = (_b = this._providerUrl) === null || _b === void 0 ? void 0 : _b.origin) !== null && _c !== void 0 ? _c : '');\n          if (!this.autoApprove) {\n            (_d = this._popup) === null || _d === void 0 ? void 0 : _d.focus();\n          }\n        }\n      });\n    });\n  }\n  get publicKey() {\n    return this._publicKey;\n  }\n  get connected() {\n    return this._publicKey !== null;\n  }\n  get autoApprove() {\n    return this._autoApprove;\n  }\n  connect() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this._popup) {\n        this._popup.close();\n      }\n      yield this.handleConnect();\n    });\n  }\n  disconnect() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this._injectedProvider) {\n        yield this.sendRequest('disconnect', {});\n      }\n      if (this._popup) {\n        this._popup.close();\n      }\n      this.handleDisconnect();\n    });\n  }\n  sign(data, display) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!(data instanceof Uint8Array)) {\n        throw new Error('Data must be an instance of Uint8Array');\n      }\n      const response = yield this.sendRequest('sign', {\n        data,\n        display\n      });\n      const signature = bs58.decode(response.signature);\n      const publicKey = new PublicKey(response.publicKey);\n      return {\n        signature,\n        publicKey\n      };\n    });\n  }\n  signTransaction(transaction) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const response = yield this.sendRequest('signTransaction', {\n        message: bs58.encode(transaction.serializeMessage())\n      });\n      const signature = bs58.decode(response.signature);\n      const publicKey = new PublicKey(response.publicKey);\n      transaction.addSignature(publicKey, signature);\n      return transaction;\n    });\n  }\n  signAllTransactions(transactions) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const response = yield this.sendRequest('signAllTransactions', {\n        messages: transactions.map(tx => bs58.encode(tx.serializeMessage()))\n      });\n      const signatures = response.signatures.map(s => bs58.decode(s));\n      const publicKey = new PublicKey(response.publicKey);\n      transactions = transactions.map((tx, idx) => {\n        tx.addSignature(publicKey, signatures[idx]);\n        return tx;\n      });\n      return transactions;\n    });\n  }\n  diffieHellman(publicKey) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!(publicKey instanceof Uint8Array)) {\n        throw new Error('Data must be an instance of Uint8Array');\n      }\n      const response = yield this.sendRequest('diffieHellman', {\n        publicKey\n      });\n      return response;\n    });\n  }\n}\nfunction isString(a) {\n  return typeof a === 'string';\n}\nfunction isInjectedProvider(a) {\n  return isObject(a) && 'postMessage' in a && typeof a.postMessage === 'function';\n}\nfunction isObject(a) {\n  return typeof a === 'object' && a !== null;\n}","map":{"version":3,"mappings":"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","names":["EventEmitter","PublicKey","bs58","Wallet","constructor","provider","_network","Map","e","_injectedProvider","source","window","origin","_providerUrl","_popup","data","method","newPublicKey","params","publicKey","_publicKey","equals","handleDisconnect","_autoApprove","autoApprove","emit","result","error","promises","_responsePromises","get","id","resolve","reject","Error","disconnect","isInjectedProvider","isString","URL","hash","URLSearchParams","location","network","toString","handleConnect","_handlerAdded","addEventListener","handleMessage","_beforeUnload","Promise","sendRequest","name","open","once","removeEventListener","forEach","delete","connected","requestId","_nextRequestId","set","postMessage","jsonrpc","focus","connect","close","sign","display","Uint8Array","response","signature","decode","signTransaction","transaction","message","encode","serializeMessage","addSignature","signAllTransactions","transactions","messages","map","tx","signatures","s","idx","diffieHellman","a","isObject"],"sourceRoot":"","sources":["../../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module","externalDependencies":[]}